# Monorepo migration plan

## Overview

This document outlines the complete migration of the `starlight-nix-template` repository to a Bun workspace monorepo with semantic-release automation, including repository renaming and package reorganization.

## Naming changes

### Repository
- Current: `starlight-nix-template`
- New: `typescript-nix-template`

### Packages
- Package 1 (current codebase): `@sciexp/docs`
  - Location: `packages/docs/`
  - Description: Astro Starlight documentation site
- Package 2 (future addition): `@sciexp/sqlrooms-hf-ducklake`
  - Location: `packages/sqlrooms-hf-ducklake/`
  - Description: To be added after migration completes

### Repository URL
- New: `https://github.com/sciexp/typescript-nix-template.git`

## Design decisions

### Release configuration
- Follow python-nix-template convention exactly
- All semantic-release config in place but releases **disabled initially**
- Enable releases later by uncommenting GitHub Actions workflow trigger
- semantic-release-monorepo plugin handles per-package change detection automatically
- No manual path filtering needed in CI - the plugin scopes analysis to commits affecting each package
- Main branch only (no beta branch initially)
- Initial version: `0.1.0` (when releases enabled)

### Changelog and git plugin strategy
Following python-nix-template convention:
- Include `@semantic-release/changelog` plugin - generates CHANGELOG.md
- Include `@semantic-release/git` plugin - commits CHANGELOG.md back with `[skip ci]`
- Package.json version remains `"0.0.0-development"` (semantic-release determines actual version from commits)
- No npm publishing (`npmPublish: false`)
- Git plugin commits only CHANGELOG.md (no package.json version updates since we don't publish)
- The `[skip ci]` commit message flag prevents infinite CI loops
- This provides complete audit trail in repository while keeping automated commits minimal

### Tag strategy
Following python-nix-template pattern with scoped tags:
- Root-level tags: `v1.0.0`, `v1.0`, `v1` (from semantic-release-major-tag)
- Package-specific tags: `docs-v1.0.0`, `docs-v1.0`, `docs-v1`
- Second package will use: `sqlrooms-hf-ducklake-v1.0.0`, etc.
- All tags created automatically by semantic-release when enabled

### Commit message enforcement
- Rely on PR review process (no pre-commit hooks for commitlint)
- Document conventional commit format in CONTRIBUTING.md
- Required format: `<type>(<scope>): <subject>`
  - Types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `chore`
  - Scope: package name (e.g., `docs`, `sqlrooms-hf-ducklake`)
  - Examples:
    - `feat(docs): add dark mode toggle`
    - `fix(sqlrooms-hf-ducklake): handle null values in query results`
    - `docs: update installation guide`

### Workspace structure rationale
- Use `packages/` directory (not `apps/` + `packages/`) to match python-nix-template
- Simpler structure appropriate for current scope (can refactor later if needed)
- Both packages are relatively equal in importance
- Clear package naming indicates purpose without directory-level categorization

## Final directory structure

```
typescript-nix-template/
├── packages/
│   └── docs/                        # Renamed and relocated from root
│       ├── src/                     # Moved from root
│       ├── public/                  # Moved from root
│       ├── e2e/                     # Moved from root
│       ├── tests/                   # Moved from root
│       ├── package.json             # Package-specific config + semantic-release
│       ├── astro.config.ts          # Moved from root
│       ├── wrangler.jsonc           # Moved from root
│       ├── worker-configuration.d.ts # Moved from root
│       ├── biome.json               # Moved from root (or shared at root)
│       ├── tsconfig.json            # Extends root tsconfig
│       ├── vitest.config.ts         # Moved from root
│       ├── playwright.config.ts     # Moved from root
│       ├── CHANGELOG.md             # Auto-generated by semantic-release
│       └── README.md                # Package-specific documentation
├── package.json                     # Workspace root + shared semantic-release config
├── tsconfig.json                    # Root tsconfig (shared base config)
├── bun.lockb                        # Moved from bun.lock
├── flake.nix                        # Updated description, unchanged structure
├── flake.lock                       # Unchanged
├── .envrc                           # Unchanged
├── justfile                         # Updated for workspace commands
├── .github/
│   ├── workflows/
│   │   ├── ci.yaml                  # Updated for workspace structure
│   │   ├── release.yaml             # NEW - semantic-release workflow (triggers commented out)
│   │   └── deploy-docs.yaml         # Updated paths for workspace
│   └── actions/
│       └── setup-nix/               # Unchanged
├── nix/
│   └── modules/                     # Unchanged
├── docs/                            # Project-level documentation
│   ├── notes/
│   │   └── migration/
│   │       └── monorepo-migration-plan.md  # This document
│   └── (other documentation)
├── scripts/                         # Existing scripts (paths may need updates)
├── vars/                            # SOPS secrets (unchanged)
├── dist/                            # Build output (gitignored)
├── node_modules/                    # Dependencies (gitignored)
├── .git/                            # Git repository
├── .gitignore                       # Updated if needed
├── .sops.yaml                       # Unchanged
├── .vscode/                         # Unchanged
├── README.md                        # Updated for monorepo structure
└── CONTRIBUTING.md                  # NEW - conventional commit guidelines
```

## Configuration file specifications

### Root package.json

```json
{
  "name": "typescript-nix-template",
  "version": "0.0.0-development",
  "private": true,
  "description": "TypeScript project template with Nix, Bun workspaces, and semantic-release",
  "repository": {
    "type": "git",
    "url": "https://github.com/sciexp/typescript-nix-template.git"
  },
  "license": "MIT",
  "workspaces": [
    "packages/*"
  ],
  "packageManager": "bun@1.1.38",
  "scripts": {
    "test-release": "semantic-release --dry-run --no-ci"
  },
  "devDependencies": {
    "@semantic-release/changelog": "^6.0.3",
    "@semantic-release/git": "^10.0.1",
    "@semantic-release/github": "^11.0.1",
    "conventional-changelog-conventionalcommits": "^8.0.0",
    "semantic-release": "^24.2.3",
    "semantic-release-major-tag": "^0.3.2",
    "semantic-release-monorepo": "^8.0.2"
  },
  "release": {
    "extends": "semantic-release-monorepo",
    "branches": [
      {
        "name": "main"
      }
    ],
    "plugins": [
      [
        "@semantic-release/commit-analyzer",
        {
          "preset": "conventionalcommits",
          "parserOpts": {
            "noteKeywords": [
              "BREAKING CHANGE",
              "BREAKING-CHANGE"
            ]
          }
        }
      ],
      [
        "@semantic-release/release-notes-generator",
        {
          "preset": "conventionalcommits",
          "parserOpts": {
            "noteKeywords": [
              "BREAKING CHANGE",
              "BREAKING-CHANGE",
              "NOTABLE CHANGE",
              "NOTABLE-CHANGE"
            ]
          }
        }
      ],
      [
        "@semantic-release/changelog",
        {
          "changelogTitle": "# Changelog"
        }
      ],
      [
        "@semantic-release/github",
        {
          "failComment": false,
          "successComment": false,
          "addReleases": "bottom"
        }
      ],
      [
        "semantic-release-major-tag",
        {
          "customTags": [
            "v${major}",
            "v${major}.${minor}"
          ]
        }
      ],
      [
        "@semantic-release/git",
        {
          "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}",
          "assets": [
            "CHANGELOG.md"
          ]
        }
      ]
    ],
    "npmPublish": false
  }
}
```

### packages/docs/package.json

```json
{
  "name": "@sciexp/docs",
  "version": "0.0.0-development",
  "private": true,
  "description": "Starlight documentation site for sciexp projects",
  "type": "module",
  "repository": {
    "type": "git",
    "url": "https://github.com/sciexp/typescript-nix-template.git"
  },
  "license": "MIT",
  "packageManager": "bun@1.1.38",
  "scripts": {
    "dev": "astro dev",
    "start": "astro dev",
    "build": "astro build",
    "preview": "astro build && wrangler dev",
    "deploy": "astro build && wrangler deploy",
    "cf-typegen": "wrangler types",
    "format": "biome format --write",
    "lint": "biome lint",
    "check": "biome check",
    "check:fix": "biome check --write",
    "test": "bun run test:unit && bun run test:e2e",
    "test:unit": "vitest run",
    "test:e2e": "playwright test",
    "test:watch": "vitest watch",
    "test:ui": "playwright test --ui",
    "test:coverage": "vitest run --coverage",
    "test-release": "semantic-release --dry-run --no-ci"
  },
  "dependencies": {
    "@astrojs/cloudflare": "^12.6.9",
    "@astrojs/starlight": "^0.36.0",
    "astro": "^5.6.1",
    "sharp": "^0.34.2"
  },
  "devDependencies": {
    "@biomejs/biome": "2.2.4",
    "@playwright/test": "~1.54.0",
    "@types/node": "^24.6.2",
    "@vitest/coverage-v8": "^3.2.4",
    "svgo": "^4.0.0",
    "vitest": "^3.2.4",
    "wrangler": "^4.42.0",
    "@semantic-release/changelog": "^6.0.3",
    "@semantic-release/git": "^10.0.1",
    "@semantic-release/github": "^11.0.1",
    "conventional-changelog-conventionalcommits": "^8.0.0",
    "semantic-release": "^24.2.3",
    "semantic-release-major-tag": "^0.3.2",
    "semantic-release-monorepo": "^8.0.2"
  },
  "release": {
    "extends": "semantic-release-monorepo",
    "branches": [
      {
        "name": "main"
      }
    ],
    "npmPublish": false,
    "plugins": [
      [
        "@semantic-release/commit-analyzer",
        {
          "preset": "conventionalcommits",
          "parserOpts": {
            "noteKeywords": [
              "BREAKING CHANGE",
              "BREAKING-CHANGE"
            ]
          }
        }
      ],
      [
        "@semantic-release/release-notes-generator",
        {
          "preset": "conventionalcommits",
          "parserOpts": {
            "noteKeywords": [
              "BREAKING CHANGE",
              "BREAKING-CHANGE",
              "NOTABLE CHANGE",
              "NOTABLE-CHANGE"
            ]
          }
        }
      ],
      [
        "@semantic-release/changelog",
        {
          "changelogTitle": "# Changelog"
        }
      ],
      [
        "@semantic-release/github",
        {
          "failComment": false,
          "successComment": false,
          "addReleases": "bottom"
        }
      ],
      [
        "semantic-release-major-tag",
        {
          "customTags": [
            "docs-v${major}",
            "docs-v${major}.${minor}"
          ]
        }
      ]
    ]
  }
}
```

### Root tsconfig.json (shared base)

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["ES2022"],
    "jsx": "react-jsx",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true
  }
}
```

### packages/docs/tsconfig.json

```json
{
  "extends": "../../tsconfig.json",
  "include": ["src/**/*", "tests/**/*", "e2e/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### Updated flake.nix

```nix
{
  description = "typescript-nix-template: TypeScript monorepo with Astro, Bun, and Nix";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    systems.url = "github:nix-systems/default";

    flake-parts = {
      url = "github:hercules-ci/flake-parts";
      inputs.nixpkgs-lib.follows = "nixpkgs";
    };

    git-hooks.url = "github:cachix/git-hooks.nix";
    git-hooks.flake = false;
  };

  outputs =
    inputs@{
      self,
      flake-parts,
      nixpkgs,
      ...
    }:
    flake-parts.lib.mkFlake { inherit inputs; } {
      systems = import inputs.systems;

      imports = with builtins; map (fn: ./nix/modules/${fn}) (attrNames (readDir ./nix/modules));
    };
}
```

## GitHub Actions workflows

### .github/workflows/release.yaml (NEW - initially disabled)

```yaml
name: Release

# DISABLED: Uncomment 'on:' section below to enable releases
# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:
#     inputs:
#       dry-run:
#         description: "Dry run (no actual release)"
#         required: false
#         type: boolean
#         default: false

# For testing only - remove when enabling releases
on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Dry run (no actual release)"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      # Ensure releases run sequentially to avoid conflicts
      max-parallel: 1
      matrix:
        package:
          - name: docs
            path: packages/docs
          # Add future packages here:
          # - name: sqlrooms-hf-ducklake
          #   path: packages/sqlrooms-hf-ducklake
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        with:
          installer: quick
          system: x86_64-linux
          setup-cachix: true

      - name: Install dependencies
        run: nix develop -c bun install

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ${{ matrix.package.path }}
          nix develop -c bunx semantic-release \
            ${{ inputs.dry-run == true && '--dry-run' || '' }}

      - name: Output release results
        if: always()
        run: |
          echo "Release workflow completed for ${{ matrix.package.name }}"
          echo "Check the logs above for details"
```

### .github/workflows/ci.yaml (updated sections only)

```yaml
# ... existing workflow structure ...

jobs:
  # ... existing scan and set-variables jobs ...

  nix:
    # ... existing nix job unchanged ...

  test:
    needs: [set-variables]
    if: |
      !cancelled() &&
      needs.set-variables.outputs.skip_ci != 'true' &&
      (github.event_name != 'workflow_dispatch' ||
       inputs.job == '' ||
       inputs.job == 'test')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - name: docs
            path: packages/docs
    concurrency:
      group: test-${{ matrix.package.name }}-${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref_name }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        with:
          installer: ${{ inputs.nix_installer || 'quick' }}
          system: x86_64-linux
          setup-cachix: true
      - name: Install dependencies
        run: nix develop -c bun install
      - name: Run unit tests
        run: nix develop -c bun run --filter '@sciexp/${{ matrix.package.name }}' test:unit
      - name: Build for E2E tests
        run: nix develop -c bun run --filter '@sciexp/${{ matrix.package.name }}' build
      - name: Run E2E tests
        run: nix develop -c bun run --filter '@sciexp/${{ matrix.package.name }}' test:e2e
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.package.name }}
          path: ${{ matrix.package.path }}/dist/
          retention-days: 7
          include-hidden-files: true
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.package.name }}
          path: ${{ matrix.package.path }}/playwright-report/
          retention-days: 7
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package.name }}
          path: ${{ matrix.package.path }}/coverage/
          retention-days: 7

  deploy:
    # ... existing deploy job with updated paths ...
```

### .github/workflows/deploy-docs.yaml (updated paths)

Update all paths to reference `packages/docs/`:

```yaml
# Example updates needed:
- name: Install dependencies
  run: nix develop -c bun install

- name: Build
  run: nix develop -c bun run --filter '@sciexp/docs' build

- name: Deploy
  env:
    CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  run: |
    cd packages/docs
    nix develop -c bunx wrangler deploy
```

## Updated justfile

Add workspace-aware commands:

```justfile
# ... existing header ...

## Workspace

# Install all workspace dependencies
[group('workspace')]
install:
  bun install

# Clean all workspace build artifacts
[group('workspace')]
clean:
  rm -rf packages/*/dist packages/*/node_modules

# Run command in specific package
[group('workspace')]
pkg package +command:
  cd packages/{{ package }} && {{ command }}

# Run command in docs package
[group('workspace')]
docs +command:
  cd packages/docs && {{ command }}

## Testing (updated)

# Run all tests in all packages
[group('testing')]
test:
  bun run --filter '@sciexp/*' test

# Run tests in specific package
[group('testing')]
test-pkg package:
  bun run --filter '@sciexp/{{ package }}' test

# Run unit tests in docs
[group('testing')]
test-unit:
  bun run --filter '@sciexp/docs' test:unit

# Run E2E tests in docs
[group('testing')]
test-e2e:
  bun run --filter '@sciexp/docs' test:e2e

## Release

# Test semantic release (dry run) for specific package
[group('release')]
test-release package="docs":
  cd packages/{{ package }} && bun run test-release

# Test semantic release for all packages
[group('release')]
test-release-all:
  @for pkg in packages/*; do \
    echo "Testing release for $pkg"; \
    cd "$pkg" && bun run test-release && cd ../..; \
  done

## Docs (updated for new location)

# Start development server
[group('docs')]
dev:
  bun run --filter '@sciexp/docs' dev

# Build the documentation site
[group('docs')]
build:
  bun run --filter '@sciexp/docs' build

# Preview the built site
[group('docs')]
preview:
  bun run --filter '@sciexp/docs' preview

# ... rest of justfile with updated paths ...
```

## Migration execution steps

### Step 1: Preparation

```bash
# Ensure working directory is clean
git status

# Create backup branch
git checkout -b backup-before-monorepo
git push -u origin backup-before-monorepo

# Return to main and create migration branch
git checkout main
git checkout -b 00-migrate-to-monorepo
```

### Step 2: Create directory structure

```bash
# Create packages directory
mkdir -p packages/docs

# Create documentation directory for this plan
mkdir -p docs/notes/migration
```

### Step 3: Move files to packages/docs/

```bash
# Move source directories
mv src packages/docs/
mv public packages/docs/
mv e2e packages/docs/
mv tests packages/docs/

# Move configuration files
mv astro.config.ts packages/docs/
mv wrangler.jsonc packages/docs/
mv worker-configuration.d.ts packages/docs/
mv biome.json packages/docs/
mv vitest.config.ts packages/docs/
mv playwright.config.ts packages/docs/

# Copy tsconfig.json to root (will be modified as base config)
cp tsconfig.json tsconfig.base.json
mv tsconfig.json packages/docs/
```

### Step 4: Create new configuration files

Create files according to specifications above:
- Root `package.json` (workspace config)
- `packages/docs/package.json`
- Root `tsconfig.json` (base config)
- Update `packages/docs/tsconfig.json` to extend root
- Update `flake.nix` description

### Step 5: Update GitHub Actions

Create new files and update existing:
- Create `.github/workflows/release.yaml` (disabled)
- Update `.github/workflows/ci.yaml` (test job with matrix)
- Update `.github/workflows/deploy-docs.yaml` (paths)

### Step 6: Update justfile

Add workspace commands and update existing commands for new structure.

### Step 7: Update documentation

```bash
# Update README.md with monorepo structure
# Create CONTRIBUTING.md with conventional commit guidelines
# Create packages/docs/README.md
```

### Step 8: Install dependencies

```bash
# Install workspace dependencies
bun install

# Verify lock file generation
ls -la bun.lockb
```

### Step 9: Test build and tests

```bash
# Test build
cd packages/docs
bun run build

# Test unit tests
bun run test:unit

# Test E2E tests
bun run test:e2e

# Return to root
cd ../..
```

### Step 10: Test in Nix environment

```bash
# Enter Nix dev shell
nix develop

# Install dependencies
bun install

# Run tests
bun run --filter '@sciexp/docs' test

# Build
bun run --filter '@sciexp/docs' build

# Exit dev shell
exit
```

### Step 11: Test semantic-release (dry run)

```bash
# Test at root level
bun run test-release

# Test at package level
cd packages/docs
bun run test-release
cd ../..
```

### Step 12: Verify Nix flake

```bash
# Check flake
nix flake check --impure

# Show flake info
nix flake show
```

### Step 13: Commit changes

```bash
# Stage all changes
git add .

# Commit with conventional commit message
git commit -m "refactor: migrate to bun monorepo with semantic-release

- Rename repository to typescript-nix-template
- Rename main package to @sciexp/docs
- Move package to packages/docs/
- Add workspace configuration in root package.json
- Add semantic-release configuration (disabled)
- Update GitHub Actions workflows for monorepo
- Update justfile for workspace commands
- Update documentation

BREAKING CHANGE: Repository structure changed to monorepo
"
```

### Step 14: Push and create PR

```bash
# Push branch
git push -u origin 00-migrate-to-monorepo

# Create PR
gh pr create --title "refactor: migrate to bun monorepo with semantic-release" \
  --body "Migrates repository to monorepo structure with semantic-release automation.

## Changes
- Repository renamed to typescript-nix-template
- Package renamed to @sciexp/docs
- Workspace structure created with packages/ directory
- Semantic-release configured (disabled initially)
- GitHub Actions updated for monorepo
- Justfile updated for workspace commands

## Testing
- [x] Local build successful
- [x] Tests passing (unit + E2E)
- [x] Nix flake check passes
- [x] Semantic-release dry run successful
- [ ] CI passes (verify after push)

## Breaking changes
Repository structure changed - updates required for:
- Local development environments
- CI/CD pipelines (already updated)
- Documentation references

## Follow-up
- Enable semantic-release after verifying structure
- Add second package (sqlrooms-hf-ducklake)
"
```

### Step 15: Verify CI passes

Monitor GitHub Actions to ensure:
- GitGuardian scan passes
- Nix CI passes
- Test job passes with new matrix structure
- Deploy job uses correct paths

### Step 16: Merge to main

After CI verification and approval:
```bash
# Merge PR
gh pr merge --squash --delete-branch
```

### Step 17: Verify post-merge

```bash
# Switch to main and pull
git checkout main
git pull

# Verify structure
ls -la packages/docs/

# Test again
nix develop -c bun install
nix develop -c bun run --filter '@sciexp/docs' test
```

## Adding second package (future)

When ready to add `@sciexp/sqlrooms-hf-ducklake`:

### Directory structure
```bash
mkdir -p packages/sqlrooms-hf-ducklake/src
cd packages/sqlrooms-hf-ducklake
```

### Create package.json
```json
{
  "name": "@sciexp/sqlrooms-hf-ducklake",
  "version": "0.0.0-development",
  "private": true,
  "description": "SQL interface for HuggingFace datasets with DuckDB backend",
  "type": "module",
  "repository": {
    "type": "git",
    "url": "https://github.com/sciexp/typescript-nix-template.git"
  },
  "license": "MIT",
  "packageManager": "bun@1.1.38",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "scripts": {
    "build": "bun build src/index.ts --outdir dist --target node",
    "dev": "bun run --watch src/index.ts",
    "test": "bun test",
    "test:watch": "bun test --watch",
    "type-check": "tsc --noEmit",
    "test-release": "semantic-release --dry-run --no-ci"
  },
  "dependencies": {
    "duckdb": "^1.2.0"
  },
  "devDependencies": {
    "@types/node": "^24.6.2",
    "typescript": "^5.9.2",
    "@semantic-release/changelog": "^6.0.3",
    "@semantic-release/git": "^10.0.1",
    "@semantic-release/github": "^11.0.1",
    "conventional-changelog-conventionalcommits": "^8.0.0",
    "semantic-release": "^24.2.3",
    "semantic-release-major-tag": "^0.3.2",
    "semantic-release-monorepo": "^8.0.2"
  },
  "release": {
    "extends": "semantic-release-monorepo",
    "branches": [
      {
        "name": "main"
      }
    ],
    "npmPublish": false,
    "plugins": [
      [
        "@semantic-release/commit-analyzer",
        {
          "preset": "conventionalcommits",
          "parserOpts": {
            "noteKeywords": [
              "BREAKING CHANGE",
              "BREAKING-CHANGE"
            ]
          }
        }
      ],
      [
        "@semantic-release/release-notes-generator",
        {
          "preset": "conventionalcommits",
          "parserOpts": {
            "noteKeywords": [
              "BREAKING CHANGE",
              "BREAKING-CHANGE",
              "NOTABLE CHANGE",
              "NOTABLE-CHANGE"
            ]
          }
        }
      ],
      [
        "@semantic-release/changelog",
        {
          "changelogTitle": "# Changelog"
        }
      ],
      [
        "@semantic-release/github",
        {
          "failComment": false,
          "successComment": false,
          "addReleases": "bottom"
        }
      ],
      [
        "semantic-release-major-tag",
        {
          "customTags": [
            "sqlrooms-hf-ducklake-v${major}",
            "sqlrooms-hf-ducklake-v${major}.${minor}"
          ]
        }
      ]
    ]
  }
}
```

### Update .github/workflows/release.yaml

Uncomment the second package in the matrix:
```yaml
matrix:
  package:
    - name: docs
      path: packages/docs
    - name: sqlrooms-hf-ducklake
      path: packages/sqlrooms-hf-ducklake
```

### Update .github/workflows/ci.yaml

Add second package to test matrix:
```yaml
matrix:
  package:
    - name: docs
      path: packages/docs
    - name: sqlrooms-hf-ducklake
      path: packages/sqlrooms-hf-ducklake
```

### Commit new package
```bash
git add packages/sqlrooms-hf-ducklake
git commit -m "feat(sqlrooms-hf-ducklake): add initial package structure"
```

## Enabling releases (future)

When ready to enable semantic-release:

### Update .github/workflows/release.yaml

Replace the commented section:
```yaml
# Change from:
on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Dry run (no actual release)"
        required: false
        type: boolean
        default: true

# To:
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Dry run (no actual release)"
        required: false
        type: boolean
        default: false
```

### Commit and verify
```bash
git add .github/workflows/release.yaml
git commit -m "ci: enable semantic-release automation

Releases will now run automatically on push to main branch."
git push

# Watch for release workflow to run
gh run watch
```

### First release verification

After enabling, the next conventional commit to main will trigger:
1. semantic-release analyzes commits since last tag
2. Determines version bump (patch/minor/major)
3. Generates CHANGELOG.md
4. Creates GitHub release with notes
5. Creates tags (e.g., `docs-v0.1.0`, `v0.1`, `v0`)
6. Commits CHANGELOG.md back with [skip ci]

Verify in GitHub:
- Check Releases page for new release
- Verify tags created correctly
- Check commit history for changelog commit

## References

### Conventional commit format

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types:**
- `feat`: New feature (triggers minor version bump)
- `fix`: Bug fix (triggers patch version bump)
- `docs`: Documentation only changes
- `style`: Code style changes (formatting, etc.)
- `refactor`: Code refactoring without feature/fix
- `perf`: Performance improvements
- `test`: Adding or updating tests
- `chore`: Maintenance tasks
- `ci`: CI/CD changes
- `build`: Build system changes

**Breaking changes:**
- Add `BREAKING CHANGE:` in footer (triggers major version bump)
- Or use `!` after type: `feat(api)!: remove deprecated endpoint`

**Scope:**
- Use package name: `docs`, `sqlrooms-hf-ducklake`
- Or component name within package
- Or omit for cross-cutting changes

**Examples:**
```bash
# Feature in specific package
feat(docs): add search functionality

# Bug fix with scope
fix(sqlrooms-hf-ducklake): handle null values in query results

# Breaking change
feat(docs)!: migrate to Astro 5

BREAKING CHANGE: Astro 5 requires Node 18+

# Multiple scopes affected
refactor(docs,sqlrooms-hf-ducklake): update typescript to 5.9

# Documentation
docs: update installation guide

# Chore
chore: update dependencies
```

## Validation checklist

Before considering migration complete:

- [ ] Repository renamed to typescript-nix-template
- [ ] Package renamed to @sciexp/docs
- [ ] All files moved to packages/docs/
- [ ] Root package.json configured as workspace
- [ ] Package-specific package.json created
- [ ] tsconfig structure created (root + package)
- [ ] flake.nix description updated
- [ ] GitHub Actions workflows updated
- [ ] justfile updated for workspace commands
- [ ] README.md updated
- [ ] CONTRIBUTING.md created
- [ ] Local build successful
- [ ] Local tests passing (unit + E2E)
- [ ] Nix flake check passes
- [ ] Semantic-release dry run successful
- [ ] CI passes on PR
- [ ] Documentation complete
- [ ] All references to old names updated

## Post-migration tasks

After successful migration and merge:

1. **Update local clones**
   ```bash
   # For team members
   git checkout main
   git pull
   bun install
   ```

2. **Update CI/CD secrets** (if needed)
   - Verify GITHUB_TOKEN permissions
   - Verify SOPS_AGE_KEY access

3. **Document release process**
   - Add to README: how releases work
   - Add to CONTRIBUTING: commit message guidelines
   - Add to project docs: tag strategy

4. **Plan second package addition**
   - Define scope for sqlrooms-hf-ducklake
   - Set up development branch
   - Follow "Adding second package" section

5. **Plan release enablement**
   - Verify all conventional commits in place
   - Test dry runs thoroughly
   - Follow "Enabling releases" section
   - Monitor first automated release

## Troubleshooting

### Issue: Bun workspace not resolving packages
**Solution:** Ensure workspaces array in root package.json matches directory structure

### Issue: semantic-release not detecting changes
**Solution:** Verify commits follow conventional format, check semantic-release-monorepo plugin

### Issue: Nix flake check fails
**Solution:** Verify flake.nix syntax, check nix/modules/ imports

### Issue: GitHub Actions can't find package
**Solution:** Check matrix.package.path matches actual directory structure

### Issue: Tests fail after move
**Solution:** Verify all relative import paths, check tsconfig.json paths

### Issue: Circular dependency in workspaces
**Solution:** Review dependency declarations, ensure no package depends on itself

### Issue: Release workflow commits fail
**Solution:** Verify GITHUB_TOKEN has contents:write permission

## Summary

This migration transforms the repository from a single-package project to a scalable monorepo with automated semantic versioning, while maintaining full compatibility with the existing Nix-based development environment and CI/CD pipeline.

The approach follows proven patterns from python-nix-template while adapting for TypeScript/Bun ecosystem specifics, ensuring consistent release management across the sciexp organization's repositories.

Key benefits:
- Automated versioning based on conventional commits
- Clear audit trail via auto-generated changelogs and GitHub releases
- Scalable structure ready for additional packages
- No breaking changes to development workflow
- Preserved Nix flake structure and devshell
- Prepared for future npm publishing if needed
