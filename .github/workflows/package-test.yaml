name: Package Test

on:
  workflow_dispatch:
    inputs:
      package-name:
        description: "Name of the package to test"
        required: true
        type: string
      package-path:
        description: "Path to the package directory"
        required: true
        type: string
      debug-enabled:
        description: "Run with tmate.io debugging enabled"
        required: false
        type: boolean
        default: false
      nix-installer:
        description: "Nix installer strategy (quick or full)"
        required: false
        type: string
        default: "quick"
      force-run:
        description: "Force execution even if already successful"
        required: false
        type: boolean
        default: false

  workflow_call:
    inputs:
      package-name:
        description: "Name of the package to test"
        required: true
        type: string
      package-path:
        description: "Path to the package directory"
        required: true
        type: string
      debug-enabled:
        description: "Run with tmate.io debugging enabled"
        required: false
        type: string
        default: "false"
      nix-installer:
        description: "Nix installer strategy (quick or full)"
        required: false
        type: string
        default: "quick"
      force-run:
        description: "Force execution even if already successful"
        required: false
        type: string
        default: "false"
    secrets:
      SOPS_AGE_KEY:
        required: true

defaults:
  run:
    shell: bash

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check execution cache
        id: cache
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: ${{ inputs.package-name }}-test
          hash-sources: 'packages/${{ inputs.package-name }}/**/* bun.lock flake.nix flake.lock .github/actions/setup-nix/action.yml .github/workflows/package-test.yaml'
          force-run: ${{ inputs.force-run }}

      - name: setup nix
        if: steps.cache.outputs.should-run == 'true'
        uses: ./.github/actions/setup-nix
        with:
          installer: ${{ inputs.nix-installer }}
          system: x86_64-linux

      - name: install dependencies
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --accept-flake-config -c bun install

      - name: run unit tests with coverage
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --accept-flake-config -c just ${{ inputs.package-name }}-test-coverage

      - name: build for e2e tests
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --accept-flake-config -c just ${{ inputs.package-name }}-build

      # Uncomment for interactive debugging of e2e test failures
      # - name: Setup tmate session for debugging
      #   if: steps.cache.outputs.should-run == 'true' && inputs.debug-enabled == 'true'
      #   uses: mxschmitt/action-tmate@v3
      #   with:
      #     limit-access-to-actor: true

      - name: run e2e tests
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --accept-flake-config -c just ${{ inputs.package-name }}-test-e2e

      - name: Create job result marker
        if: success() && steps.cache.outputs.should-run == 'true' && steps.cache.outputs.cache-source == 'none'
        shell: bash
        run: |
          mkdir -p "${{ steps.cache.outputs.cache-path }}"
          cat > "${{ steps.cache.outputs.cache-path }}/marker" <<EOF
          {
            "success": true,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "cache_key": "${{ steps.cache.outputs.cache-key }}",
            "workflow_run_id": "${{ github.run_id }}",
            "package": "${{ inputs.package-name }}"
          }
          EOF

      - name: Save job result to cache
        if: success() && steps.cache.outputs.should-run == 'true' && steps.cache.outputs.cache-source == 'none'
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5
        with:
          path: ${{ steps.cache.outputs.cache-path }}
          key: ${{ steps.cache.outputs.cache-key }}

      - name: upload test results
        if: always() && steps.cache.outputs.should-run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-playwright-report
          path: packages/${{ inputs.package-name }}/playwright-report/
          retention-days: 7

      - name: upload coverage
        if: always() && steps.cache.outputs.should-run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-coverage
          path: packages/${{ inputs.package-name }}/coverage/
          retention-days: 7
