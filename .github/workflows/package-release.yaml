name: Package Release

on:
  workflow_dispatch:
    inputs:
      package-path:
        description: "Path to the package directory"
        required: true
        type: string
      package-name:
        description: "Name of the package"
        required: true
        type: string
      release-dry-run:
        description: "Whether to run the release in dry-run mode"
        required: false
        type: boolean
        default: false
      debug-enabled:
        description: "Enable tmate debug session"
        required: false
        type: boolean
        default: false
      checkout-ref:
        description: "Git ref to checkout"
        required: false
        type: string
        default: ""
      force-run:
        description: "Force execution even if already successful"
        required: false
        type: boolean
        default: false

  workflow_call:
    inputs:
      package-path:
        description: "Path to the package directory"
        required: true
        type: string
      package-name:
        description: "Name of the package"
        required: true
        type: string
      release-dry-run:
        description: "Whether to run the release in dry-run mode"
        required: false
        type: string
        default: "false"
      debug-enabled:
        description: "Enable tmate debug session"
        required: false
        type: boolean
        default: false
      checkout-ref:
        description: "Git ref to checkout"
        required: false
        type: string
        default: ""
      force-run:
        description: "Force execution even if already successful"
        required: false
        type: string
        default: "false"
    secrets:
      SOPS_AGE_KEY:
        required: true
    outputs:
      version:
        description: "Released version"
        value: ${{ jobs.release.outputs.version }}
      released:
        description: "Whether a new release was published"
        value: ${{ jobs.release.outputs.released }}
      tag:
        description: "Git tag created for the release"
        value: ${{ jobs.release.outputs.tag }}

defaults:
  run:
    shell: bash

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    outputs:
      version: ${{ steps.release-info.outputs.version }}
      released: ${{ steps.release-info.outputs.released }}
      tag: ${{ steps.release-info.outputs.tag }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.checkout-ref != '' && inputs.checkout-ref || github.ref }}
          persist-credentials: false

      # NOTE: Production releases intentionally DO NOT save cache results.
      # This ensures fresh builds for all production deployments per ADR-0016.
      # Cache lookup may skip if prior release already succeeded, but new
      # releases always execute with current code state.
      - name: Check execution cache
        id: cache
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: ${{ inputs.package-name }}-release
          hash-sources: 'packages/${{ inputs.package-name }}/**/* bun.lock justfile .github/actions/setup-nix/action.yml .github/workflows/package-release.yaml'
          force-run: ${{ inputs.force-run }}

      - name: Setup Nix
        if: steps.cache.outputs.should-run == 'true'
        uses: ./.github/actions/setup-nix
        with:
          installer: quick
          system: x86_64-linux

      - name: Install dependencies
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --accept-flake-config -c bun install

      - name: Run semantic-release
        id: semantic-release
        if: steps.cache.outputs.should-run == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          nix develop --accept-flake-config -c just release-package ${{ inputs.package-name }} ${{ inputs.release-dry-run }}

      - name: Extract release info
        if: always()
        id: release-info
        run: |
          # Extract version and tag from git if release was created
          # For dry-run mode, these will remain as defaults
          if [ "${{ inputs.release-dry-run }}" = "false" ]; then
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$LATEST_TAG" ]; then
              # Extract version from tag (e.g., docs-v1.2.3 -> 1.2.3)
              VERSION=$(echo "$LATEST_TAG" | grep -oP '\d+\.\d+\.\d+' || echo "unknown")
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "released=true" >> $GITHUB_OUTPUT
              echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            else
              echo "version=unknown" >> $GITHUB_OUTPUT
              echo "released=false" >> $GITHUB_OUTPUT
              echo "tag=" >> $GITHUB_OUTPUT
            fi
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
            echo "released=false" >> $GITHUB_OUTPUT
            echo "tag=" >> $GITHUB_OUTPUT
          fi

      - name: Setup tmate debug session
        if: inputs.debug-enabled == true
        uses: mxschmitt/action-tmate@e5c7151931ca95bad1c6f4190c730ecf8c7dde48 # ratchet:mxschmitt/action-tmate@v3

      - name: Log release information
        if: always()
        run: |
          if [ "${{ steps.release-info.outputs.released }}" == "true" ]; then
            echo "Package ${{ inputs.package-name }} released version ${{ steps.release-info.outputs.version }}"
            echo "Tag: ${{ steps.release-info.outputs.tag }}"
          else
            echo "No release created for ${{ inputs.package-name }}"
          fi
