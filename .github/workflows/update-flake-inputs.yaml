name: Update Flake Inputs

on:
  schedule:
    # 3am UTC / 10pm EST / 11pm EDT
    - cron: "0 3,15 * * *"
  workflow_dispatch:
    inputs:
      auto_merge:
        description: "Enable auto-merge for created PRs"
        required: false
        type: boolean
        default: false
      exclude_patterns:
        description: "Comma-separated exclude patterns (e.g., '**/flake.nix#nixpkgs')"
        required: false
        type: string
        default: ""
  workflow_call:
    inputs:
      auto_merge:
        description: "Enable auto-merge for created PRs"
        required: false
        type: boolean
        default: false
      exclude_patterns:
        description: "Comma-separated exclude patterns"
        required: false
        type: string
        default: ""
    secrets:
      FLAKE_UPDATER_APP_ID:
        required: true
      FLAKE_UPDATER_PRIVATE_KEY:
        required: true

concurrency:
  group: update-flake-inputs-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  update-flake-inputs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.FLAKE_UPDATER_APP_ID }}
          private-key: ${{ secrets.FLAKE_UPDATER_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          installer: quick
          system: x86_64-linux

      - name: Update flake inputs
        uses: mic92/update-flake-inputs@73cb58f118541b956f5a061d12838ef1dd997867 # v1
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          exclude-patterns: ${{ inputs.exclude_patterns }}
          pr-labels: "flake-update"
          auto-merge: ${{ inputs.auto_merge && 'true' || 'false' }}
          # Upstream bug: delete-branch uses maintainer_can_modify API which only
          # works for fork PRs. Use repo setting "Automatically delete head branches"
          delete-branch: "false"
          signoff: "true"
